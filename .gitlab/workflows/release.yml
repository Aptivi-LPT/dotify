prepare_job:
  stage: prepare
  rules:
    - if: $CI_COMMIT_TAG
  script:
    - 'echo "SUBJECT=$(cat CHANGES.TITLE)" >> variables.env'
    - 'export BODYSET="$(cat CHANGES)"$''\n\n''"- SHA256 sum of dotify: $(sha256sum dotify)"'
    - 'echo "BODYBASE64=$(printf ''%s'' "${BODYSET}" | base64 -w 0)" >> variables.env'
  artifacts:
    reports:
      dotenv: variables.env

release_job:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  needs:
    - job: prepare_job
      artifacts: true
  rules:
    - if: $CI_COMMIT_TAG
  script:
    - 'echo Creating release...'
    - 'BODY="$(echo $BODYBASE64 | base64 -d)"'
    - 'release-cli --server-url https://gitlab.com --job-token=$CI_JOB_TOKEN --project-id $CI_PROJECT_ID create --name "$SUBJECT" --description "$BODY" --tag-name "$CI_COMMIT_TAG"'
