prepare_job:
  stage: prepare
  rules:
    - if: $CI_COMMIT_TAG
  script:
    - 'echo "SUBJECT=$(cat CHANGES.TITLE)" >> variables.env'
    - |
      cat >> variables.env << 'EOF'
      BODY<<HEREDOC
      $(cat CHANGES)
      - SHA256 sum of dotify: $(sha256sum dotify)
      HEREDOC
      EOF
  artifacts:
    reports:
      dotenv: variables.env

release_job:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  needs:
    - job: prepare_job
      artifacts: true
  rules:
    - if: $CI_COMMIT_TAG
  script:
    - 'echo Creating release...'
  release:
    tag_name: $CI_COMMIT_TAG
    name: '$SUBJECT'
    description: '$BODY'
